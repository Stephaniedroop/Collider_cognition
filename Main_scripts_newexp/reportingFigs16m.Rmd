---
title: "Plots of model fit for all 16 models, for all 3 pgroups, for Bramley+Droop CESM function using Pearson correlation"
output:
  html_document: default
  pdf_document: default
date: "2025-05-23"
params: 
  data_file: "../model_data/fitforplot16mpn.csv" # CHANGE INPUT DATA HERE ONLY, by replacing last two letters before '.csv' with eg 'sp' for Spearman or 'ql' for Quillien+Lucas implementation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, fig.width = 12)
```

## Source

Takes model and data in csv `fitforplot16m.csv` calculated in `optimise_withKandEps.Rmd`. 


## Note on parameters

Predictions generated from the best fitting parameter combination for each model.

All models have epsilon and tau. First eight have kappa (to go with Kindness).

```{r, include=FALSE}
library(RColorBrewer)
library(tidyverse)
#library(rlang)
library(purrr)
```

```{r, echo=FALSE}
df <- read.csv(params$data_file) # 288 obs of 27 vars 

# SOME STRINGS FOR NAMING PLOTS ETC
filename <- params$data_file 
# Extract the basename (file name only, no path)
basestring <- basename(filename)
# Remove the ".csv" extension and get the last two letters before it
last_two <- substr(sub("\\.csv$", "", basestring), nchar(basestring) - 5, nchar(basestring) - 3) 
```

This is a small extra section, you don't need it

```{r, include=FALSE}
corful <- cor.test(df$full, df$prop, method = 'pearson')
corsel <- cor.test(df$noSelect, df$prop, method = 'pearson')
```

Wrangling and renaming of some factors and variables to make them individual per trial and useful for plotting

```{r, include=FALSE}
df$structure <- ifelse(substr(df$trial_id, 3, 3) == "c", "conjunctive", 
                    ifelse(substr(df$trial_id, 3, 3) == "d", "disjunctive", NA))


df$trial_type <- recode(df$trial_id, 
                      "1_c1"="A=0,B=0,E=0",
                      "1_c2"="A=0,B=1,E=0",
                      "1_c3"="A=1,B=0,E=0",
                      "1_c4"="A=1,B=1,E=0",
                      "1_c5"="A=1,B=1,E=1",
                      "1_d1"="A=0,B=0,E=0",
                      "1_d2"="A=0,B=1,E=0",
                      "1_d3"="A=0,B=1,E=1",
                      "1_d4"="A=1,B=0,E=0",
                      "1_d5"="A=1,B=0,E=1",
                      "1_d6"="A=1,B=1,E=0",
                      "1_d7"="A=1,B=1,E=1",
                      "2_c1"="A=0,B=0,E=0",
                      "2_c2"="A=0,B=1,E=0",
                      "2_c3"="A=1,B=0,E=0",
                      "2_c4"="A=1,B=1,E=0",
                      "2_c5"="A=1,B=1,E=1",
                      "2_d1"="A=0,B=0,E=0",
                      "2_d2"="A=0,B=1,E=0",
                      "2_d3"="A=0,B=1,E=1",
                      "2_d4"="A=1,B=0,E=0",
                      "2_d5"="A=1,B=0,E=1",
                      "2_d6"="A=1,B=1,E=0",
                      "2_d7"="A=1,B=1,E=1",
                      "3_c1"="A=0,B=0,E=0",
                      "3_c2"="A=0,B=1,E=0",
                      "3_c3"="A=1,B=0,E=0",
                      "3_c4"="A=1,B=1,E=0",
                      "3_c5"="A=1,B=1,E=1",
                      "3_d1"="A=0,B=0,E=0",
                      "3_d2"="A=0,B=1,E=0",
                      "3_d3"="A=0,B=1,E=1",
                      "3_d4"="A=1,B=0,E=0",
                      "3_d5"="A=1,B=0,E=1",
                      "3_d6"="A=1,B=1,E=0",
                      "3_d7"="A=1,B=1,E=1")

df$trial_structure_type <- recode(df$trial_id, 
                                "1_c1"="Conjunctive: A=0,B=0,E=0",
                                "1_c2"="Conjunctive: A=0,B=1,E=0",
                                "1_c3"="Conjunctive: A=1,B=0,E=0",
                                "1_c4"="Conjunctive: A=1,B=1,E=0",
                                "1_c5"="Conjunctive: A=1,B=1,E=1",
                                "1_d1"="Disjunctive: A=0,B=0,E=0",
                                "1_d2"="Disjunctive: A=0,B=1,E=0",
                                "1_d3"="Disjunctive: A=0,B=1,E=1",
                                "1_d4"="Disjunctive: A=1,B=0,E=0",
                                "1_d5"="Disjunctive: A=1,B=0,E=1",
                                "1_d6"="Disjunctive: A=1,B=1,E=0",
                                "1_d7"="Disjunctive: A=1,B=1,E=1",
                                "2_c1"="Conjunctive: A=0,B=0,E=0",
                                "2_c2"="Conjunctive: A=0,B=1,E=0",
                                "2_c3"="Conjunctive: A=1,B=0,E=0",
                                "2_c4"="Conjunctive: A=1,B=1,E=0",
                                "2_c5"="Conjunctive: A=1,B=1,E=1",
                                "2_d1"="Disjunctive: A=0,B=0,E=0",
                                "2_d2"="Disjunctive: A=0,B=1,E=0",
                                "2_d3"="Disjunctive: A=0,B=1,E=1",
                                "2_d4"="Disjunctive: A=1,B=0,E=0",
                                "2_d5"="Disjunctive: A=1,B=0,E=1",
                                "2_d6"="Disjunctive: A=1,B=1,E=0",
                                "2_d7"="Disjunctive: A=1,B=1,E=1",
                                "3_c1"="Conjunctive: A=0,B=0,E=0",
                                "3_c2"="Conjunctive: A=0,B=1,E=0",
                                "3_c3"="Conjunctive: A=1,B=0,E=0",
                                "3_c4"="Conjunctive: A=1,B=1,E=0",
                                "3_c5"="Conjunctive: A=1,B=1,E=1",
                                "3_d1"="Disjunctive: A=0,B=0,E=0",
                                "3_d2"="Disjunctive: A=0,B=1,E=0",
                                "3_d3"="Disjunctive: A=0,B=1,E=1",
                                "3_d4"="Disjunctive: A=1,B=0,E=0",
                                "3_d5"="Disjunctive: A=1,B=0,E=1",
                                "3_d6"="Disjunctive: A=1,B=1,E=0",
                                "3_d7"="Disjunctive: A=1,B=1,E=1")

df<- df %>% mutate(trial_type = factor(trial_type, levels = c("A=0,B=0,E=0",
                                                              "A=0,B=1,E=0",
                                                              "A=0,B=1,E=1",
                                                              "A=1,B=0,E=0",
                                                              "A=1,B=0,E=1",
                                                              "A=1,B=1,E=0",
                                                              "A=1,B=1,E=1")),
                   trial_structure_type = factor(trial_structure_type, levels = c("Conjunctive: A=1,B=1,E=1",
                                                                                  "Conjunctive: A=1,B=1,E=0",
                                                                                  "Conjunctive: A=1,B=0,E=0",
                                                                                  "Conjunctive: A=0,B=1,E=0",
                                                                                  "Conjunctive: A=0,B=0,E=0",
                                                                                  "Disjunctive: A=0,B=1,E=0",
                                                                                  "Disjunctive: A=1,B=1,E=1",
                                                                                  "Disjunctive: A=1,B=0,E=1",
                                                                                  "Disjunctive: A=0,B=1,E=1",
                                                                                  "Disjunctive: A=1,B=1,E=0",
                                                                                  "Disjunctive: A=1,B=0,E=0",
                                                                                  "Disjunctive: A=0,B=0,E=0")),
                   # NOTE THESE (ABOVE) LOOK IN THE WRONG ORDER BUT ITS JUST FOR THE PLOT
                   pgroup = factor(pgroup, levels = 1:3, labels = c('A=.1,Au=.5,B=.8,Bu=.5',
                                                                            'A=.5,Au=.1,B=.5,Bu=.8',
                                                                            'A=.1,Au=.7,B=.8,Bu=.5')),
                   Response = factor(node3),
                   Observed = factor(!Response%in%c('Au=0','Au=1','Bu=0', 'Bu=1'), levels = c(T,F)),
                   Variable = factor(substr(node3, 1, 1)),
                   #State = factor(rep(c(0,1), 144)),
                   Actual = factor(Actual, levels = c(FALSE, TRUE), labels = c('FALSE', 'TRUE')))

```



```{r, echo=FALSE}
df$SE <- NA

# Need to add SE 
for (i in unique(df$trial_id))
{
  df$SE[df$trial_id==i]<-sqrt((df$prop[df$trial_id==i] * (1-df$prop[df$trial_id==i])) / sum(df$n[df$trial_id==i]))
}


df$Actual[is.na(df$Actual)] <- FALSE


```


## Lesions and order

Models have four 'components': *Kindness*, *Selection*, *Inference*, *Actual causation*.

The full model has all four.

Thereafter they are progressively lesioned.

They are lesioned in the following way:

- First block of eight inc. full: has Kindness, with all other modules lesioned dissociatively (naming convention 'noX' means lesioned to remove the X module.

- Next block of eight: follows the same process in order, this time without Kindness. (Kindness was incorporated as an optimised free parameter).


```{r, echo=FALSE}

models <- c('full', 
                 'noAct', 
                 'noInf', 
                 'noSelect', 
                 'noActnoInf', 
                 'noActnoSelect', 
                 'noInfnoSelect', 
                 'noActnoInfnoSelect',
                 'noKind', 
                 'noActnoKind', 
                 'noInfnoKind', 
                 'noKindnoSelect', 
                 'noActnoInfnoKind', 
                 'noActnoKindnoSelect', 
                 'noInfnoKindnoSelect', 
                 'noActnoInfnoKindnoSelect')  

pgroups <- levels(df$pgroup)


```

This next is main function for plotting any model and any pgroup. In the knitted file it will print all in order if you uncomment the following call, but it's long, so only uncomment if you want all.

```{r, include=FALSE}
# Define plotting function
plot_model_pgroup <- function(model_colname, pgroup_label, df) {
df_filtered <- df %>% filter(pgroup == pgroup_label) 
ggplot(df_filtered, aes(x = node3, y = prop, fill = Observed, colour = Actual)) +
geom_bar(stat = 'identity') +
geom_errorbar(aes(ymin = prop-SE, ymax = prop+SE), width = .2) +
labs(
x = 'Response',
y = 'Proportion/Prediction',
title = sprintf("Model %s : %s", model_colname, pgroup_label)
) +
scale_fill_brewer(palette = "Set2") + # , labels = c("Observed \n(A|B)", "Unobserved \n(Au|Bu)")
scale_colour_manual(values = c('gray', 'black')) +
  guides(fill = guide_legend(override.aes = list(shape = NA))) + 
geom_point(aes(y = .data[[model_colname]]), colour = 'black') +
geom_rect(
data = subset(df_filtered, trial_structure_type %in% c("Conjunctive: A=1,B=1,E=1", "Disjunctive: A=1,B=1,E=1")),
fill = NA, colour = "blue", xmin = -Inf, xmax = Inf, linewidth = 2,
ymin = -Inf, ymax = Inf
) +
facet_wrap(~trial_structure_type, ncol = 6) +
theme_bw() +
theme(
panel.grid = element_blank(),
axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
legend.margin = margin(c(0, 0, 0, 0)),
axis.title.x = element_text(margin = margin(t = 1, r = 0, b = 0, l = 0)),
plot.title = element_text(size = 18, face = "bold", hjust = 0.5)
)
}
```

The call to uncomment if you want individual plots for all models for all pgroups: (can be used for visual comparisons but otherwise not expected to be needed)

```{r, echo=FALSE, fig.width=12}
# for (model in models) {
# for (pgroup in pgroups) {
# print(plot_model_pgroup(model, pgroup, df))
# }
# }
```

Instead, call a single model and pgroup plot like this for example full model for pgroup3:

```{r, echo=FALSE, fig.width=12}
plotf <- plot_model_pgroup('full', 'A=.1,Au=.7,B=.8,Bu=.5', df)
print(plot)
```

Then I tend to save plots in a separate block like this using the 'last_two' letters of the data_file set in params at the top of the page.

```{r, include=FALSE}
plotname <- paste0("../figs/full3", last_two, ".pdf")
ggsave(plotname, plot = plotf)

```

Another example of the model plot, this time for model noSelect:

```{r, echo=FALSE, fig.width=12}
plotns <- plot_model_pgroup('noSelect', 'A=.1,Au=.7,B=.8,Bu=.5', df)
print(plotns)
```

And save it in the same place in the same way:

```{r, include=FALSE}
plotname <- paste0("../figs/ns3", last_two, ".pdf")
ggsave(plotname, plot = plotns)

```


## Some more specific plots

```{r, echo=FALSE, fig.width=12}
# A different function to compare two models on one plot
plot_two_models_pgroup <- function(model1, model2, pgroup_label, df) {
  df_filtered <- df %>% filter(pgroup == pgroup_label)
  ggplot(df_filtered, aes(x = node3, y = prop, fill = Observed, colour = Actual)) +
    geom_bar(stat = 'identity') +
    geom_errorbar(aes(ymin = prop-SE, ymax = prop+SE), width = .2) +
    # Model 1: black circles
    geom_point(aes(y = .data[[model1]]), 
               colour = 'black', 
               shape = 16, 
               size = 2, 
               alpha = 0.9,
               show.legend = TRUE) +
    # Model 2: red triangles
    geom_point(aes(y = .data[[model2]]), 
               colour = 'red', 
               shape = 17, 
               size = 2, 
               alpha = 0.9,
               show.legend = TRUE) +
    geom_rect(
      data = subset(df_filtered, trial_structure_type %in% c("Conjunctive: A=1,B=1,E=1", "Disjunctive: A=1,B=1,E=1")),
      fill = NA, colour = "blue", xmin = -Inf, xmax = Inf, linewidth = 2,
      ymin = -Inf, ymax = Inf
    ) +
    facet_wrap(~trial_structure_type, ncol = 6) +
    labs(
      x = 'Response',
      y = 'Proportion/Prediction',
      title = sprintf("Models %s (black) & %s (red) - Parameter Group: %s", model1, model2, pgroup_label)
    ) +
    scale_fill_brewer(palette = "Set2") + #, labels = c("Observed \n(A|B)", "Unobserved \n(Au|Bu)")) +
    scale_colour_manual(values = c('gray', 'black')) +
    theme_bw() +
    theme(
      panel.grid = element_blank(),
      axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
      legend.margin = margin(c(0, 0, 0, 0)),
      axis.title.x = element_text(margin = margin(t = 1, r = 0, b = 0, l = 0)),
plot.title = element_text(size = 18, face = "bold", hjust = 0.5)
    )
}
```


Usage: compare full and noSelect just for pgroup 3

```{r, echo=FALSE, fig.width=12}
# For example, to compare 'full' and 'noSelect' for a given pgroup:
p <- plot_two_models_pgroup('full', 'noSelect', 'A=.1,Au=.7,B=.8,Bu=.5', df)
print(p)
```

```{r, include=FALSE}
plotname <- paste0("../figs/comparefull_noSelect", last_two, ".pdf")
ggsave(plotname, plot = p)

```


Now just observed v unobserved for everything together, noKind model. It needs chunks to calculate separate long and sumamry dfs for the new se values - they are different because different numbers of observations in the means.

```{r, echo=FALSE}
# 1. Gather and calculate mean and SE per group
df_long <- df %>%
  select(trial_id, node3, prop, noKind, Observed) %>% 
  gather(key, val, prop:noKind) %>%
  filter(!is.na(val)) %>%
  mutate(key = factor(key, levels = c("prop", "noKind"),
                      labels = c("Participants", "Model")))

summary_df <- df_long %>%
  group_by(Observed, key) %>%
  summarise(
    val_sum = sum(val),
    se = sd(val) / sqrt(n())
  ) %>%
  mutate(val = val_sum / 36) %>%
  select(-val_sum) %>%
  ungroup()


# 2. Plot with bars and error bars
punnk <- ggplot(summary_df, aes(x = key, y = val, fill = Observed)) +
  geom_bar(stat = "identity", position = position_dodge(0.9)) +
  geom_errorbar(aes(ymin = val - se, ymax = val + se),
                width = 0.2, position = position_dodge(0.9)) +
  labs(x = "Response", y = "Proportion/Prediction", fill = "Variable type") +
  scale_fill_brewer(palette = "Set2", labels = c("Observed \n(A|B)", "Unobserved \n(Au|Bu)")) +
  #scale_fill_discrete(labels = c("Observed \n(A|B)", "Unobserved \n(Au|Bu)")) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.text = element_text(size = 10),
        legend.title = element_text(size = 10))

print(punnk)

```

```{r, include=FALSE, fig.width=5}
plotname <- paste0("../figs/punnk", last_two, ".pdf")
ggsave(plotname, plot = punnk)

```

Repeat just the observed v unobs for the full model just in case it's needed, although it gives the same results as noKind, because k is so small in the best fitting models


```{r, echo=FALSE}
# 1. Gather and calculate mean and SE per group
df_longf <- df %>%
  select(trial_id, node3, prop, full, Observed) %>% 
  gather(key, val, prop:full) %>%
  filter(!is.na(val)) %>%
  mutate(key = factor(key, levels = c("prop", "full"),
                      labels = c("Participants", "Model")))

summary_dff <- df_longf %>%
  group_by(Observed, key) %>%
  summarise(
    val_sum = sum(val),
    se = sd(val) / sqrt(n())
  ) %>%
  mutate(val = val_sum / 36) %>%
  select(-val_sum) %>%
  ungroup()


# 2. Plot with bars and error bars
punf <- ggplot(summary_dff, aes(x = key, y = val, fill = Observed)) +
  geom_bar(stat = "identity", position = position_dodge(0.9)) +
  geom_errorbar(aes(ymin = val - se, ymax = val + se),
                width = 0.2, position = position_dodge(0.9)) +
  labs(x = "Response", y = "Proportion/Prediction", fill = "Variable type") +
  scale_fill_brewer(palette = "Set2", labels = c("Observed \n(A|B)", "Unobserved \n(Au|Bu)")) +
  #scale_fill_discrete(labels = c("Observed \n(A|B)", "Unobserved \n(Au|Bu)")) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.text = element_text(size = 10),
        legend.title = element_text(size = 10))

print(punf)

```

```{r, include=FALSE, fig.width=5}
ppunf <- paste0("../figs/punf", last_two, ".pdf")
ggsave(ppunf, plot = punf)

```

#### A panel splitting out observed v observed, for the full model

```{r, include=FALSE}

# Now same thing for structure only
df.s <- df %>% gather(key, val, prop:full) %>% mutate(key = factor(key, levels = c('prop', 'full'),
                                                                 labels = c("Participants", "Full Model"))) %>%
  group_by(Observed, key, structure, E) %>% summarise(val = sum(val)/3)

df.s <- df.s %>% filter(!is.na(key))

df.s$struct_effect <- paste0(df.s$structure, df.s$E)

# Better
df.s$val <- ifelse(df.s$struct_effect == "conjunctive0", df.s$val/4,
                    ifelse(df.s$struct_effect == "disjunctive0", df.s$val/4,
                           ifelse(df.s$struct_effect == "disjunctive1", df.s$val/3, df.s$val)))

```

This is the two-panel plot split for Effect, for the full model, to compare structures where E=0 with E=1:

```{r, echo=FALSE, fig.width=12}

punobs_f <- ggplot(df.s, aes(y=val, x=key, fill=Observed)) +
  stat_summary(fun.y = mean,
               geom = "bar",
               position = position_dodge(), colour = 'black') +
stat_summary(fun.data = mean_se, geom = "errorbar",  position = position_dodge(.9), width = .2)+
  labs(x = 'Response', y = 'Proportion/Prediction') +
  facet_grid(structure ~ E) +
  scale_fill_brewer(palette = "Set2") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.margin=margin(c(0,0,0,0)),
        #legend.position = c(-.1,-.2),
        axis.title.x = element_text(margin = margin(t = 1, r =0, b = 0, l = 0))) 

print(punobs_f)
```

```{r, include=FALSE}
plotname <- paste0("../figs/unobs_f", last_two, ".pdf")
ggsave(plotname, plot = punobs_f)

```

#### The next two chunks make a plot for noKind for unobserved v Effect


```{r, include=FALSE}
# NOKIND
df.s2 <- df %>% gather(key, val, prop:noKind) %>% mutate(key = factor(key, levels = c('prop', 'noKind'),
                                                                 labels = c("Participants", "noKind Model"))) %>%
  group_by(Observed, key, structure, E) %>% summarise(val = sum(val)/3)

df.s2 <- df.s2 %>% filter(!is.na(key))

df.s2$struct_effect <- paste0(df.s2$structure, df.s2$E)

# Better
df.s2$val <- ifelse(df.s2$struct_effect == "conjunctive0", df.s2$val/4,
                    ifelse(df.s2$struct_effect == "disjunctive0", df.s2$val/4,
                           ifelse(df.s2$struct_effect == "disjunctive1", df.s2$val/3, df.s2$val)))

```

This is unobserved v observed two-panel plot for the noKind model, ie. the full model but without Kindness:

```{r, echo=FALSE, fig.width=12}
punobs_nk <- ggplot(df.s2, aes(y=val, x=key, fill=Observed)) +
  stat_summary(fun.y = mean,
               geom = "bar",
               position = position_dodge(), colour = 'black') +
stat_summary(fun.data = mean_se, geom = "errorbar",  position = position_dodge(.9), width = .2)+
  labs(x = 'Response', y = 'Proportion/Prediction', title = 'noKind model') +
  facet_grid(structure ~ E) +
  scale_fill_brewer(palette = "Set2") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.margin=margin(c(0,0,0,0)),
        #legend.position = c(-.1,-.2),
        axis.title.x = element_text(margin = margin(t = 1, r =0, b = 0, l = 0))) 

print(punobs_nk)
```

```{r, include=FALSE}

plotname <- paste0("../figs/unobs_nk", last_two, ".pdf")
ggsave(plotname, plot = punobs_nk)

```


#### The next two chunks make a plot for noSelect v Effect

We should also try noSelect! Here goes:


```{r, include=FALSE}
# Now same thing for structure only
df.s3 <- df %>% gather(key, val, prop:noSelect) %>% mutate(key = factor(key, levels = c('prop', 'noSelect'),
                                                                 labels = c("Participants", "noSelect Model"))) %>%
  group_by(Observed, key, structure, E) %>% summarise(val = sum(val)/3)

df.s3 <- df.s3 %>% filter(!is.na(key))

df.s3$struct_effect <- paste0(df.s3$structure, df.s3$E)

# Better
df.s3$val <- ifelse(df.s3$struct_effect == "conjunctive0", df.s3$val/4,
                    ifelse(df.s3$struct_effect == "disjunctive0", df.s3$val/4,
                           ifelse(df.s3$struct_effect == "disjunctive1", df.s3$val/3, df.s3$val)))

```

This is unobserved v observed two-panel plot for the noSelect model, ie. the full model but without CESM causal selection:

```{r, echo=FALSE, fig.width=12}
punobs_ns <- ggplot(df.s3, aes(y=val, x=key, fill=Observed)) +
  stat_summary(fun.y = mean,
               geom = "bar",
               position = position_dodge(), colour = 'black') +
stat_summary(fun.data = mean_se, geom = "errorbar",  position = position_dodge(.9), width = .2)+
  labs(x = 'Response', y = 'Proportion/Prediction', title = 'noSelect model') +
  facet_grid(structure ~ E) +
  scale_fill_brewer(palette = "Set2") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.margin=margin(c(0,0,0,0)),
        #legend.position = c(-.1,-.2),
        axis.title.x = element_text(margin = margin(t = 1, r =0, b = 0, l = 0))) 

print(punobs_ns)
```

```{r, include=FALSE}

plotname <- paste0("../figs/unobs_ns", last_two, ".pdf")
ggsave(plotname, plot = punobs_ns)

```

### A section of plots for simple 111s for a few different models: full, noSelect, noKind

```{r, echo=FALSE, fig.width=12}
row_labeller <- c(
  "A=.1,Au=.5,B=.8,Bu=.5"=".1,.5,.8,.5",
  "A=.5,Au=.1,B=.5,Bu=.8"=".5,.1,.5,.8",
  "A=.1,Au=.7,B=.8,Bu=.5"=".1,.7,.8,.5"
)

column_labeller <- c(
  "Conjunctive: A=1,B=1,E=1"="Conjunctive",
  "Disjunctive: A=1,B=1,E=1"="Disjunctive"
)

# FULL

p111f <- ggplot(df %>% filter(trial_structure_type %in% c("Conjunctive: A=1,B=1,E=1", "Disjunctive: A=1,B=1,E=1"), Actual==T), # There was Actual==T here but see no reason for it
       aes(x=Variable, y=prop, fill=Observed)) +
  geom_bar(stat = 'identity', colour = 'black', position = position_dodge()) +
  geom_errorbar(aes(ymin=prop-SE, ymax=prop+SE), width=.2, position = position_dodge(.9)) + 
  labs(x = 'Response', y = 'Proportion/Prediction', title = 'Full model') +
  scale_fill_brewer(palette = "Set2")+
  geom_point(data = df %>% filter(trial_structure_type %in% c("Conjunctive: A=1,B=1,E=1", "Disjunctive: A=1,B=1,E=1"), Actual==T), aes(y=full), colour = 'black', size = 3, position = position_dodge(.9)) + # also here ', Actual==T' after D111) 
  facet_grid(trial_structure_type ~ pgroup,
             labeller = labeller(pgroup = column_labeller, trial_structure_type = row_labeller)) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        #legend.position = 'none',
        axis.title.x = element_text(margin = margin(t = 1, r =0, b = 0, l = 0))) 

print(p111f)

```

```{r, include=FALSE}
plotname <- paste0("../figs/111f", last_two, ".pdf")
ggsave(plotname, plot = p111f)

```

```{r, echo=FALSE}
# NOSELECT

p111ns <- ggplot(df %>% filter(trial_structure_type %in% c("Conjunctive: A=1,B=1,E=1", "Disjunctive: A=1,B=1,E=1"), Actual==T),
       aes(x=Variable, y=prop, fill=Observed)) +
  geom_bar(stat = 'identity', colour = 'black', position = position_dodge()) +
  geom_errorbar(aes(ymin=prop-SE, ymax=prop+SE), width=.2, position = position_dodge(.9)) + 
  labs(x = 'Response', y = 'Proportion/Prediction', title = 'noSelect model')+
  scale_fill_brewer(palette = "Set2")+
  geom_point(data = df %>% filter(trial_structure_type %in% c("Conjunctive: A=1,B=1,E=1", "Disjunctive: A=1,B=1,E=1"), Actual==T), aes(y=noSelect), colour = 'red', size = 3, position = position_dodge(.9)) +
  facet_grid(trial_structure_type ~ pgroup,
             labeller = labeller(pgroup = column_labeller, trial_structure_type = row_labeller)) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        #legend.position = 'none',
        axis.title.x = element_text(margin = margin(t = 1, r =0, b = 0, l = 0))) 

print(p111ns)

```

```{r, include=FALSE}
plotname <- paste0("../figs/111ns", last_two, ".pdf")
ggsave(plotname, plot = p111ns)
```

```{r, echo=FALSE}
# NOKIND

p111nk <- ggplot(df %>% filter(trial_structure_type %in% c("Conjunctive: A=1,B=1,E=1", "Disjunctive: A=1,B=1,E=1"), Actual==T),
       aes(x=Variable, y=prop, fill=Observed)) +
  geom_bar(stat = 'identity', colour = 'black', position = position_dodge()) +
  geom_errorbar(aes(ymin=prop-SE, ymax=prop+SE), width=.2, position = position_dodge(.9)) + 
  labs(x = 'Response', y = 'Proportion/Prediction', title = 'noKind model')+
  scale_fill_brewer(palette = "Set2")+
  geom_point(data = df %>% filter(trial_structure_type %in% c("Conjunctive: A=1,B=1,E=1", "Disjunctive: A=1,B=1,E=1"), Actual==T), aes(y=noKind), colour = 'blue', size = 3, position = position_dodge(.9)) +
  facet_grid(trial_structure_type ~ pgroup,
             labeller = labeller(pgroup = column_labeller, trial_structure_type = row_labeller)) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        #legend.position = 'none',
        axis.title.x = element_text(margin = margin(t = 1, r =0, b = 0, l = 0))) 

print(p111nk)
```

```{r, include=FALSE}
plotname <- paste0("../figs/111nk", last_two, ".pdf")
ggsave(plotname, plot = p111nk)

```

### Compound decision

Did they suggest A or B?

Same split as above but for Variable only:


```{r, echo=FALSE}
# Now same thing for A/B only
df4 <- df %>% gather(key, val, prop:full) %>% mutate(key = factor(key, levels = c('prop', 'full'),
                                                                 labels = c("Participants", "Full Model"))) %>%
  group_by(Variable, key) %>% summarise(val = sum(val)/36)

df4 <- df4 %>% filter(!is.na(key))

pab <- ggplot(df4, aes(y=val, x=key, fill=Variable)) +
  stat_summary(fun.y = mean,
               geom = "bar",
               position = position_dodge(), colour = 'black') +
stat_summary(fun.data = mean_se, geom = "errorbar",  position = position_dodge(.9), width = .2)+
  labs(x = 'Response', y = 'Proportion/Prediction', title = 'A v B') +
  #facet_grid(structure ~ E) +
  scale_fill_brewer(palette = "Set2") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.margin=margin(c(0,0,0,0)),
        #legend.position = c(-.1,-.2),
        axis.title.x = element_text(margin = margin(t = 1, r =0, b = 0, l = 0))) 

print(pab)
```


```{r, include=FALSE}
plotname <- paste0("../figs/abcomp", last_two, ".pdf")
ggsave(plotname, plot = pab)

```

Now we want a chart like the 111 one, but for a compound decision for AvB. This will split the complex disjunction of two conjunctions up. FULLMODEL

```{r, echo=FALSE}
# FULL MODEL
df5 <- df %>% 
  filter(trial_structure_type %in% c("Conjunctive: A=1,B=1,E=1", "Disjunctive: A=1,B=1,E=1")) %>% 
  select(trial_id, pgroup, full, prop, trial_structure_type, Variable, Actual, SE) 

# Summarize mean proportions by group (A, B)
df_bar <- df5 %>%
  group_by(pgroup, trial_structure_type, Variable) %>%
  summarise(Participants = sum(prop), 
            FullModel = sum(full),
            .groups = 'drop')

# Summarize SE separately for error bars
df_error <- df5 %>%
  group_by(pgroup, trial_structure_type, Variable) %>%
  summarise(
    mean_prop = sum(prop),
    se = sqrt(sum(SE^2)),  # Example assuming independence; adapt based on your data
    .groups = 'drop'
  )

p111abf <- ggplot() +
  geom_col(data = df_bar, aes(x = Variable, y = Participants, fill = Variable),
           position = position_dodge()) +
  geom_errorbar(data = df_error,
                aes(x = Variable, ymin = mean_prop - se, ymax = mean_prop + se),
                width = 0.2,
                position = position_dodge(.9)) +
  scale_fill_brewer(palette = "Set2", name = "Participants \nand variable") +
  guides(fill = guide_legend(override.aes = list(shape = NA))) +
  geom_point(data = df_bar, aes(x = Variable, y = FullModel, shape = "Full Model", color = "Full Model"),
             size = 3, position = position_dodge(.9), show.legend = TRUE) +
  scale_shape_manual(name = "", values = c("Full Model" = 16)) +
  scale_color_manual(name = "", values = c("Full Model" = "blue")) +
  labs(x = 'Response', y = 'Proportion/Prediction', title = 'A v B for the 111 cases') +
  facet_grid(trial_structure_type ~ pgroup) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(vjust = 0.5, hjust=1),
        legend.margin=margin(c(0,0,0,0)),
        axis.title.x = element_text(margin = margin(t = 1, r =0, b = 0, l = 0)),
        legend.text = element_text(size = 10),  # here thats 'Full Model'
        legend.title = element_text(size = 10))  # here 'Participants and variable'


print(p111abf)
```

```{r, include=FALSE}
plotname <- paste0("../figs/111abf", last_two, ".pdf")
ggsave(plotname, plot = p111abf)
```

Then just the same, but for noSelect



```{r, echo=FALSE}
# noSelect MODEL
df6 <- df %>% 
  filter(trial_structure_type %in% c("Conjunctive: A=1,B=1,E=1", "Disjunctive: A=1,B=1,E=1")) %>% 
  select(trial_id, pgroup, noSelect, prop, trial_structure_type, Variable, Actual, SE) 

# Summarize mean proportions by group (A, B)
df_bar <- df6 %>%
  group_by(pgroup, trial_structure_type, Variable) %>%
  summarise(Participants = sum(prop), 
            nSModel = sum(noSelect),
            .groups = 'drop')

# Summarize SE separately for error bars
df_error <- df6 %>%
  group_by(pgroup, trial_structure_type, Variable) %>%
  summarise(
    mean_prop = sum(prop),
    se = sqrt(sum(SE^2)),  
    .groups = 'drop'
  )

p111abns <- ggplot() +
  geom_col(data = df_bar, aes(x = Variable, y = Participants, fill = Variable),
           position = position_dodge()) +
  geom_errorbar(data = df_error,
                aes(x = Variable, ymin = mean_prop - se, ymax = mean_prop + se),
                width = 0.2,
                position = position_dodge(.9)) +
  scale_fill_brewer(palette = "Set2", name = "Participants \nand variable") +
  guides(fill = guide_legend(override.aes = list(shape = NA))) +
  geom_point(data = df_bar, aes(x = Variable, y = nSModel, shape = "noSelect Model", color = "noSelect Model"),
             size = 3, position = position_dodge(.9), show.legend = TRUE) +
  scale_shape_manual(name = "", values = c("noSelect Model" = 16)) +
  scale_color_manual(name = "", values = c("noSelect Model" = "red")) +
  labs(x = 'Response', y = 'Proportion/Prediction', title = 'A v B for the 111 cases') +
  facet_grid(trial_structure_type ~ pgroup) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(vjust = 0.5, hjust=1),
        legend.margin=margin(c(0,0,0,0)),
        axis.title.x = element_text(margin = margin(t = 1, r =0, b = 0, l = 0)),
        legend.text = element_text(size = 10),  # here thats 'noSelect Model'
        legend.title = element_text(size = 10))  # here 'Participants and variable'


print(p111abns)
```

NOTE: WHEN I WANT TO PUT THESE IN THE GITHUB README, CONVERT TO PNG OR JPEG FIRST THEN EMBED IN HTML OR MKD - it won't do pdf

```{r, include=FALSE}
plotname <- paste0("../figs/111abns", last_two, ".pdf")
ggsave(plotname, plot = p111abns)
```